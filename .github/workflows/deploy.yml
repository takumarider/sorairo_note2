name: Deploy to Render

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CI ãƒã‚§ãƒƒã‚¯ (ãƒ†ã‚¹ãƒˆãƒ»ãƒ“ãƒ«ãƒ‰ãƒ»å“è³ª)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    name: CI Checks
    uses: ./.github/workflows/ci.yml

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Render ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: ci
    environment: production

    steps:
      - name: Trigger Render Deploy Hook
        run: |
          echo "ðŸš€ Deploying to Render..."
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.RENDER_DEPLOY_HOOK_URL }}")
          if [ "$response" -eq 200 ] || [ "$response" -eq 201 ]; then
            echo "âœ… Deploy triggered successfully (HTTP $response)"
          else
            echo "::error::Deploy hook failed with HTTP $response"
            exit 1
          fi

      - name: Wait for deploy health check
        if: ${{ vars.RENDER_SERVICE_URL != '' }}
        run: |
          echo "â³ Waiting for deployment to become healthy..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            status=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.RENDER_SERVICE_URL }}" || echo "000")
            if [ "$status" -eq 200 ]; then
              echo "âœ… Service is healthy (attempt $attempt/$max_attempts)"
              exit 0
            fi
            echo "â³ Attempt $attempt/$max_attempts â€” HTTP $status, retrying in 10s..."
            sleep 10
          done
          echo "::warning::Health check timed out after $max_attempts attempts"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
